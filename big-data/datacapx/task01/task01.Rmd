---
title: "Project Task 1"
output: _html_notebook
---

# Web References

- https://laptrinhx.com/text-mining-in-r-a-tutorial-889565373/
- https://statisticsglobe.com/r-error-cannot-allocate-vector-of-size-n-gb
- https://www.kaggle.com/aquaregis32/text-mining-rmarkdown

# Import Libraries

```{r}
library(tidyverse)
library(lubridate)
library(tidytext)
library(tm)
library(SnowballC)
```

# Data Load

1.	Read in the reddit dataset correctly and provide evidence of your code.

```{r}
reddit <- read.csv("RS_2017-09_filtered70.csv")
reddit <- as_tibble(reddit)
reddit
```

# Data Clean

2.	Remove the first column of the data frame and provide evidence.

```{r}
reddit <- select(reddit, -X)
reddit
```

3.	Correctly identify and remove the columns that contain no data. Provide a list of the variables removed and evidence of your code. 

## Identify Columns with no data

```{r}
reddit.is_empty <- reddit %>%
  apply(
    MARGIN=2,
    FUN=function(x) all(is.na(x))) %>%
  data.frame

colnames(reddit.is_empty)[1] <- "empty"

reddit.is_empty %>%
  filter(empty == TRUE)
```

## Remove Empty Columns

```{r}
reddit <- reddit[, !sapply(reddit, function(x) all(is.na(x))), drop=FALSE]
reddit
```

4.	Your code correctly identified and removed the columns that contained only one value. Provide a list of the variables removed and evidence of your code. 

## Identify Columns with only one value

```{r}
reddit %>% 
  select_if(~n_distinct(.) == 1) %>%
  head(1)
```
## Remove columns with a single value

```{r}
reddit <- reddit %>% 
  select_if(~n_distinct(.) > 1)
  
reddit
```



```{r}
is.na(reddit) %>%
  as_tibble() %>%
  gather(key="column", value="empty") %>%
  filter(empty == FALSE) %>%
  group_by(column) %>%
  summarise(count=n())
```

5.	Convert the variables created_utc and retrieved_on to unordered factors containing the weekdays. Provide tables of the frequencies for the two new variables and evidence of your code. 

## Convert the columns to abbreviated week day names

```{r}
reddit <- reddit %>%
  mutate(created_utc = as.POSIXct(created_utc, origin = "1970-01-01"))  %>%
  mutate(retrieved_on = as.POSIXct(retrieved_on, origin = "1970-01-01")) %>%
  mutate(created_utc = wday(created_utc, label=TRUE, abbr=TRUE))  %>%
  mutate(retrieved_on = wday(retrieved_on, label=TRUE, abbr=TRUE))
```

## Convert the columns to factors

```{r}
reddit$created_utc <- factor(reddit$created_utc)
reddit$retrieved_on <- factor(reddit$retrieved_on)
```

## summarize created_utc

```{r}
reddit %>%
  select(created_utc) %>%
  group_by(created_utc) %>%
  summarise(freq=n())
```

## summarize retrieved_on

```{r}
reddit %>%
  select(retrieved_on) %>%
  group_by(retrieved_on) %>%
  summarise(freq=n())
```

## Another test

```{r}
#reddit %>%
#  select(created_utc, retrieved_on) %>%
#  mutate(created_utc = as.POSIXct(created_utc, origin = "1970-01-01"))  %>%
#  mutate(retrieved_on = as.POSIXct(retrieved_on, origin = "1970-01-01")) %>%
#  mutate(created_utc = wday(created_utc, label=TRUE, abbr=TRUE))  %>%
#  mutate(retrieved_on = wday(retrieved_on, label=TRUE, abbr=TRUE)) %>%
#  gather(key="column", value="weekday") %>%
#  group_by(column, weekday) %>%
#  summarise(count=n())
```

6.	Your code successfully converts the titles of the reddit posts to an incidence matrix of the words that appear in at least 500 posts. Provide a list of the words that appear in at least 500 posts and incorporate the incidence matrix into the reddit data frame. Provided evidence of your code.

## Step 6.1: Convert all letters to lowercase. 
Step 6.2: Remove numbers.
Step 6.4: Remove punctuation.
Step 6.5: Eliminate extra white space.


```{r}
#reddit.titles <- reddit %>%
#  select(title) %>%
#  mutate(title=tolower(title)) %>%
#  mutate(title=gsub("\\d+", "", title)) %>%
#  mutate(title=gsub("[[:punct:]]", "", title)) %>%
#  mutate(title=gsub("\\s+", " ", str_trim(title)))
#  
#reddit.titles
```



Step 6.3: Remove stop words such as "the".

```{r}
#data(stop_words)
#
#reddit.titles %>%
#  unnest_tokens(word, title) %>%
#  anti_join(stop_words, by = "word")
```



6.	Your code successfully converts the titles of the reddit posts to an incidence matrix of the words that appear in at least 500 posts. Provide a list of the words that appear in at least 500 posts and incorporate the incidence matrix into the reddit data frame. Provided evidence of your code.

## Step 6.1: Convert all letters to lowercase. 


```{r}
docs <- Corpus(VectorSource(pull(reddit, title)))
docs <- tm_map(docs, content_transformer(tolower))
```

## Step 6.3: Remove stop words such as "the".

```{r}
docs <- tm_map(docs, removeWords, stopwords("english"))
```

## Step 6.2: Remove numbers.

```{r}
docs <- tm_map(docs, removeNumbers)
```

## Step 6.4: Remove punctuation.

```{r}
docs <- tm_map(docs, removePunctuation)
docs <- tm_map(docs, content_transformer(function(x) gsub(x, pattern = "–", replacement = " ")))
```

## Step 6.5: Eliminate extra white space.

```{r}
docs <- tm_map(docs, stripWhitespace)
```

## Step 6.6: Reduce all words to their stem words. For example, "car", "car's" and "cars" are all reduced to the stem "car". In some cases, the stem may not be a complete word. For example, “removed” and “removal” might be transformed to a common stem, “remov”.

```{r}
docs <- tm_map(docs, stemDocument)
```


Step 6.7: Represent the data as an incidence matrix with one column for each stem word and one row for each post. The body of the matrix should contain "1" when the title contains the word and "0" otherwise.


```{r}
# get the document term matrix and convert it to an incidence matrix
dtm <- TermDocumentMatrix(docs)
dtm$v <-rep(1, length(dtm$v))
```

Step 6.8: For the purpose of this project, attention will be restricted to words that appear in at least 500 titles. You will need to remove all words that appear less frequently.

```{r}
# find terms that appears at least in 500 titles
ft <- findFreqTerms(dtm, lowfreq=500)

# filter the document term matrix to only frequent terms
dtm<-dtm[Terms(dtm)%in%ft,]
```

Step 6.9: The final result should be a matrix with 139,823 rows and one column for each word that appears at least 500 times. When this is obtained, the titles column should be removed from and the incidence matrix added to the reddit data frame.

```{r}
# convert the dtm to a matrix
m <- as.matrix(dtm)
v <- sort(rowSums(m),decreasing=TRUE)
d <- data.frame(word = names(v),freq=v)

pull(d, word)
```

```{r}
# transpose the matrix and add a column prefix
m <- t(m)
colnames(m) <- paste("title", colnames(m), sep = "_")

#add the incident matrix data to the reddit data frame
reddit <- bind_cols(reddit, as_tibble(m), .name_repair="unique")

# remove the title column
reddit <- select(reddit, -title)

colnames(reddit)
```






